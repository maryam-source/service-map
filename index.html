<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeff's Project Portfolio | Colorado</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --house-green: #27ae60; 
            --star-gold: #fbc02d; 
        }

        body { font-family: 'Montserrat', sans-serif; margin: 0; background-color: #fff; }
        
        /* CENTERED HEADER */
        .header { text-align: center; padding: 30px 20px; background: #fdfdfd; border-bottom: 1px solid #eee; }
        h1 { margin: 0; font-size: 1.8rem; font-weight: 700; color: #1a1a1a; }
        .subtitle { color: #666; font-size: 0.9rem; margin-top: 5px; }

        /* CENTERED MAP BOX */
        #map { 
            height: 700px; width: 95%; max-width: 1300px;
            margin: 20px auto; border-radius: 8px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid #ddd;
        }

        /* SOLID GREEN HOUSE PIN */
        .house-wrapper { transition: 0.2s; }
        .house-wrapper:hover { transform: scale(1.4); z-index: 1000 !important; }
        
        .house-pin {
            width: 24px; height: 18px;
            background: var(--house-green);
            position: relative;
            border-radius: 1px;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.25));
        }
        .house-pin::before { /* Roof */
            content: ''; position: absolute; top: -11px; left: -2px;
            border-left: 14px solid transparent;
            border-right: 14px solid transparent;
            border-bottom: 11px solid var(--house-green);
        }
        .house-pin::after { /* Door (Now Green to match house) */
            content: ''; position: absolute; bottom: 0; left: 8px;
            width: 8px; height: 9px;
            background: var(--house-green);
            border-top: 1px solid rgba(0,0,0,0.1); /* Subtle line to define door */
        }

        /* POPUP STYLING */
        .leaflet-popup-content-wrapper { border-radius: 4px; padding: 8px; }
        .value-label { font-size: 10px; color: #999; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
        .value-amount { font-size: 18px; font-weight: 700; color: var(--house-green); margin-bottom: 8px; }
        .star-rating { color: var(--star-gold); font-size: 16px; margin-bottom: 8px; }
        
        .review-quote { 
            font-style: italic; font-size: 12px; color: #444; 
            margin-bottom: 12px; line-height: 1.4; display: block;
            border-left: 2px solid var(--house-green); padding-left: 8px;
        }
        
        .address-text { font-size: 12px; color: #444; border-top: 1px solid #eee; padding-top: 10px; line-height: 1.4; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Project Portfolio: Colorado</h1>
        <p class="subtitle">Showcasing 100+ high-value installations across the state</p>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
        const map = L.map('map', { scrollWheelZoom: false }).setView([40.1, -104.9], 8);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '©CartoDB'
        }).addTo(map);

        L.Control.geocoder({ defaultMarkGeocode: false, placeholder: "Search city or zip...", position: 'topright' })
            .on('markgeocode', e => map.setView(e.geocode.center, 12))
            .addTo(map);

        const houseIcon = L.divIcon({
            className: 'house-wrapper',
            html: '<div class="house-pin"></div>',
            iconSize: [28, 28],
            iconAnchor: [14, 14],
            popupAnchor: [0, -15]
        });

        const formatter = new Intl.NumberFormat('en-US', {
            style: 'currency', currency: 'USD',
        });

        Papa.parse("data.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                const markers = [];
                results.data.forEach(job => {
                    if(job.lat && job.lng && parseFloat(job.lat) !== 0) {
                        const priceDisplay = formatter.format(job.price);
                        const starsHtml = '★'.repeat(5);

                        // Only show review if it exists in data.csv and is longer than 5 chars
                        const hasReview = (job.review && job.review.length > 5 && job.review !== "Verified Customer");
                        const reviewHtml = hasReview ? `<span class="review-quote">"${job.review}"</span>` : '';

                        const popupContent = `
                            <div style="width:200px">
                                <div class="value-label">Total Job Amount</div>
                                <div class="value-amount">${priceDisplay}</div>
                                <div class="star-rating">${starsHtml}</div>
                                ${reviewHtml}
                                <div class="address-text"><strong>Site:</strong><br>${job.address}</div>
                            </div>
                        `;

                        L.marker([parseFloat(job.lat), parseFloat(job.lng)], {icon: houseIcon})
                            .addTo(map)
                            .bindPopup(popupContent);
                        
                        markers.push([parseFloat(job.lat), parseFloat(job.lng)]);
                    }
                });
                
                if(markers.length > 0) {
                    map.fitBounds(L.latLngBounds(markers), { padding: [50, 50] });
                }
            }
        });
    </script>
</body>
</html>